<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoulArt Oracle Deck</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cormorant Garamond', serif;
      background-color: #fdfaf6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    .nav-icons {
      position: fixed;
      top: 1rem;
      left: 1rem;
      display: flex;
      gap: 0.75rem;
      z-index: 200;
    }

    .nav-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #c9a227 0%, #e8d48b 50%, #c9a227 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 3px 12px rgba(200, 150, 62, 0.4);
      transition: all 0.3s ease;
      animation: shimmer-idle 3s ease-in-out infinite;
    }

    .nav-icon:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 20px rgba(200, 150, 62, 0.6);
    }

    .nav-icon:active {
      animation: shimmer-click 0.6s ease-out;
    }

    .nav-icon svg {
      width: 22px;
      height: 22px;
      stroke: #3d2914;
      fill: none;
      stroke-width: 2;
    }

    @keyframes shimmer-idle {
      0%, 100% {
        box-shadow: 0 3px 12px rgba(200, 150, 62, 0.4);
      }
      50% {
        box-shadow: 0 3px 18px rgba(232, 212, 139, 0.7);
      }
    }

    @keyframes shimmer-click {
      0% {
        box-shadow: 0 0 0 0 rgba(232, 212, 139, 0.8);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 0 20px 10px rgba(232, 212, 139, 0.4);
        transform: scale(1.15);
      }
      100% {
        box-shadow: 0 3px 12px rgba(200, 150, 62, 0.4);
        transform: scale(1);
      }
    }

    .page-header {
      text-align: center;
      padding: 2rem 1rem 1rem;
      padding-top: 4rem;
    }

    h1 {
      font-size: 2.5rem;
      color: #3d2914;
      margin: 0 0 0.5rem 0;
    }

    .subtitle {
      color: #8a7a6a;
      font-size: 1.1rem;
      font-style: italic;
      margin: 0;
    }

    .deck-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      padding: 1rem;
      background: linear-gradient(135deg, #f5efe6 0%, #fdfaf6 100%);
      border-bottom: 1px solid #e8dfd0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .deck-controls button {
      background-color: #d8c298;
      color: #3d2914;
      padding: 0.6rem 1.25rem;
      font-size: 1rem;
      font-family: inherit;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .deck-controls button:hover {
      background-color: #c5aa80;
      transform: translateY(-2px);
    }

    .deck-controls button.active {
      background-color: #3d2914;
      color: #fdfaf6;
    }

    .section-title {
      text-align: center;
      color: #5a4530;
      font-size: 1.3rem;
      margin: 1.5rem 0 1rem;
      font-weight: 400;
    }

    .draw-area {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
      padding: 1rem 1rem 2rem;
      min-height: 380px;
    }

    .draw-area:empty::after {
      content: 'Choose a draw option above to reveal your cards';
      color: #8a7a6a;
      font-style: italic;
      font-size: 1.1rem;
    }

    .gallery-section {
      background: linear-gradient(180deg, #f5efe6 0%, #fdfaf6 100%);
      padding: 1rem 0 2rem;
      border-top: 1px solid #e8dfd0;
    }

    .card-carousel {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      padding: 1rem 2rem;
      scroll-snap-type: x mandatory;
      scrollbar-width: thin;
      scrollbar-color: #d8c298 #f5efe6;
    }

    .card-carousel::-webkit-scrollbar {
      height: 8px;
    }

    .card-carousel::-webkit-scrollbar-track {
      background: #f5efe6;
      border-radius: 4px;
    }

    .card-carousel::-webkit-scrollbar-thumb {
      background: #d8c298;
      border-radius: 4px;
    }

    .card-container {
      flex: 0 0 auto;
      width: 180px;
      height: 280px;
      perspective: 1000px;
      cursor: pointer;
      scroll-snap-align: center;
    }

    .card-container.large {
      width: 220px;
      height: 340px;
    }

    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
    }

    .card-container.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .card-front {
      background-color: #2a1f1a;
    }

    .card-front img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card-back {
      background: linear-gradient(135deg, #fdfaf6 0%, #f5efe6 100%);
      transform: rotateY(180deg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 1.25rem;
      text-align: center;
      border: 2px solid #d8c298;
    }

    .card-back h2 {
      color: #3d2914;
      font-size: 1.3rem;
      margin: 0 0 0.75rem 0;
      font-weight: 600;
    }

    .card-container.large .card-back h2 {
      font-size: 1.5rem;
    }

    .card-back p {
      color: #5a4530;
      font-size: 0.95rem;
      line-height: 1.5;
      margin: 0;
    }

    .card-container.large .card-back p {
      font-size: 1rem;
      line-height: 1.6;
    }

    .card-container:not(.flipped):hover .card-inner {
      transform: rotateY(10deg) scale(1.02);
    }

    .card-container:not(.flipped) .card-front::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(200,150,62,0.3) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .card-container:not(.flipped):hover .card-front::after {
      opacity: 1;
    }

    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      padding: 1rem;
    }

    .reset-btn, .save-btn {
      background: transparent;
      border: 1px solid #d8c298;
      color: #8a7a6a;
      padding: 0.5rem 1.5rem;
      font-size: 0.95rem;
      font-family: inherit;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .reset-btn:hover, .save-btn:hover {
      background: #d8c298;
      color: #3d2914;
    }

    .save-btn {
      background: linear-gradient(135deg, #c9a227 0%, #e8d48b 50%, #c9a227 100%);
      color: #3d2914;
      border: none;
      font-weight: 600;
    }

    .save-btn:hover {
      box-shadow: 0 4px 15px rgba(200, 150, 62, 0.5);
    }

    .save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .instruction {
      text-align: center;
      color: #8a7a6a;
      font-size: 1rem;
      font-style: italic;
      margin: 0.5rem 0;
    }

    .success-message {
      text-align: center;
      color: #4a7c59;
      font-size: 1rem;
      padding: 0.75rem;
      background: #e8f5e9;
      border-radius: 8px;
      margin: 1rem auto;
      max-width: 400px;
      display: none;
    }

    .journal-section {
      background: linear-gradient(180deg, #fdfaf6 0%, #f5efe6 100%);
      padding: 2rem 1rem;
      border-top: 1px solid #e8dfd0;
      max-width: 700px;
      margin: 0 auto;
    }

    .journal-section h2 {
      text-align: center;
      color: #3d2914;
      font-size: 1.5rem;
      margin: 0 0 0.5rem 0;
    }

    .journal-section .subtitle {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .journal-textarea {
      width: 100%;
      min-height: 180px;
      padding: 1rem;
      font-family: inherit;
      font-size: 1rem;
      border: 2px solid #e8dfd0;
      border-radius: 12px;
      background: #fdfaf6;
      color: #3d2914;
      resize: vertical;
      transition: border-color 0.3s;
    }

    .journal-textarea:focus {
      outline: none;
      border-color: #c9a227;
    }

    .journal-textarea::placeholder {
      color: #a99a8a;
      font-style: italic;
    }

    .journal-prompts {
      margin-top: 1rem;
      padding: 1rem;
      background: #f5efe6;
      border-radius: 10px;
    }

    .journal-prompts h3 {
      color: #5a4530;
      font-size: 1.1rem;
      margin: 0 0 0.75rem 0;
    }

    .journal-prompts ul {
      margin: 0;
      padding-left: 1.25rem;
      color: #6a5a4a;
      font-size: 0.95rem;
      line-height: 1.8;
    }

    .journal-save-btn {
      display: block;
      margin: 1.5rem auto 0;
      background: linear-gradient(135deg, #c9a227 0%, #e8d48b 50%, #c9a227 100%);
      color: #3d2914;
      border: none;
      padding: 0.75rem 2rem;
      font-size: 1.1rem;
      font-family: inherit;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .journal-save-btn:hover {
      box-shadow: 0 4px 15px rgba(200, 150, 62, 0.5);
      transform: translateY(-2px);
    }

    .journal-save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .login-prompt {
      text-align: center;
      color: #8a7a6a;
      font-size: 1rem;
      padding: 1rem;
    }

    .login-prompt a {
      color: #c9a227;
      text-decoration: none;
      font-weight: 600;
    }

    .login-prompt a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .page-header {
        padding: 1rem 0.75rem 0.75rem;
        padding-top: 3.5rem;
      }

      h1 {
        font-size: 1.75rem;
      }

      .subtitle {
        font-size: 1rem;
      }

      .deck-controls {
        gap: 0.5rem;
        padding: 0.75rem 0.5rem;
      }

      .deck-controls button {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        flex: 1 1 45%;
        min-width: 120px;
      }

      .draw-area {
        padding: 0.75rem;
        min-height: 280px;
        gap: 0.75rem;
      }

      .card-container {
        width: 120px;
        height: 190px;
      }
      
      .card-container.large {
        width: 140px;
        height: 220px;
      }
      
      .card-back {
        padding: 0.75rem;
      }

      .card-back h2 {
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
      }
      
      .card-back p {
        font-size: 0.75rem;
        line-height: 1.4;
      }

      .card-container.large .card-back h2 {
        font-size: 1.1rem;
      }

      .card-container.large .card-back p {
        font-size: 0.85rem;
      }

      .action-buttons {
        flex-direction: column;
        padding: 0.75rem;
        gap: 0.5rem;
      }

      .reset-btn, .save-btn {
        width: 100%;
        padding: 0.75rem 1rem;
      }

      .gallery-section {
        padding: 0.75rem 0 1.5rem;
      }

      .section-title {
        font-size: 1.1rem;
        margin: 1rem 0 0.5rem;
      }

      .instruction {
        font-size: 0.9rem;
      }

      .card-carousel {
        padding: 0.75rem 1rem;
        gap: 0.75rem;
      }

      .journal-section {
        padding: 1.25rem 1rem;
        margin: 0;
        border-radius: 0;
      }

      .journal-section h2 {
        font-size: 1.25rem;
      }

      .journal-textarea {
        min-height: 140px;
        font-size: 0.95rem;
        padding: 0.75rem;
      }

      .journal-prompts {
        padding: 0.75rem;
      }

      .journal-prompts h3 {
        font-size: 1rem;
      }

      .journal-prompts ul {
        font-size: 0.85rem;
        padding-left: 1rem;
        line-height: 1.6;
      }

      .journal-save-btn {
        width: 100%;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
      }

      .success-message {
        margin: 0.75rem;
        font-size: 0.9rem;
      }

      .login-prompt {
        padding: 0.75rem;
        font-size: 0.9rem;
      }

      .nav-icons {
        top: 0.5rem;
        left: 0.5rem;
      }

      .nav-icon {
        width: 38px;
        height: 38px;
      }

      .nav-icon svg {
        width: 18px;
        height: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="nav-icons">
    <a href="home.html" class="nav-icon" title="Home">
      <svg viewBox="0 0 24 24">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
    </a>
    <a href="members-dashboard.html" class="nav-icon" title="Members Dashboard">
      <svg viewBox="0 0 24 24">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
    </a>
  </div>

  <div class="page-header">
    <h1>SoulArt Oracle Deck</h1>
    <p class="subtitle">Draw guidance for your journey</p>
  </div>

  <div class="deck-controls">
    <button onclick="drawRandom(1)">1 Card Pull</button>
    <button onclick="drawRandom(3)">3 Card Spread</button>
    <button onclick="drawRandom(5)">5 Card Deep Dive</button>
    <button onclick="drawRandom('random')">Random Draw</button>
  </div>

  <div id="drawArea" class="draw-area"></div>
  
  <div class="action-buttons" id="actionButtons" style="display: none;">
    <button class="reset-btn" onclick="resetDraw()">Draw Again</button>
    <button class="save-btn" id="saveBtn" onclick="saveReading()">Save Sacred Reading</button>
  </div>
  
  <div class="success-message" id="successMessage"></div>

  <div class="gallery-section">
    <h2 class="section-title">Browse the Full Deck</h2>
    <p class="instruction">Click any card to reveal its message</p>
    <div id="gallery" class="card-carousel"></div>
    
    <div class="action-buttons" id="galleryActionButtons" style="display: none;">
      <button class="save-btn" id="gallerySaveBtn" onclick="saveGallerySelection()">Save Selected Cards to Profile</button>
    </div>
    <div class="success-message" id="gallerySuccessMessage"></div>
  </div>

  <div class="journal-section" id="journalSection" style="display: none;">
    <h2>Sacred Journal: Oracle Reflection</h2>
    <p class="subtitle">Document your thoughts about this reading</p>
    
    <textarea class="journal-textarea" id="reflectionText" placeholder="What feelings arose when you saw these cards? What wisdom do they offer you today?"></textarea>
    
    <div class="journal-prompts">
      <h3>Reflection Prompts</h3>
      <ul>
        <li>What immediate emotions did the card(s) stir within you?</li>
        <li>How does this message relate to your current life situation?</li>
        <li>What action or intention does this reading inspire?</li>
        <li>Is there a Stored Shadow Emotion being highlighted for release?</li>
      </ul>
    </div>
    
    <button class="journal-save-btn" id="journalSaveBtn" onclick="saveJournalReflection()">Save Reflection</button>
  </div>
  
  <div class="login-prompt" id="loginPrompt" style="display: none;">
    <p>To save your readings and reflections, please <a href="login.html">sign in</a> or <a href="register.html">create an account</a>.</p>
  </div>

  <script src="scripts/oracle.js"></script>
  <script>
    let currentDrawnCards = [];
    let currentReadingId = null;
    let isAuthenticated = false;

    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/check');
        const data = await response.json();
        isAuthenticated = data.authenticated;
        updateUIForAuth();
      } catch (e) {
        isAuthenticated = false;
        updateUIForAuth();
      }
    }

    function updateUIForAuth() {
      const saveBtn = document.getElementById('saveBtn');
      const loginPrompt = document.getElementById('loginPrompt');
      
      if (!isAuthenticated && currentDrawnCards.length > 0) {
        loginPrompt.style.display = 'block';
      } else {
        loginPrompt.style.display = 'none';
      }
    }

    let galleryFlippedCards = [];

    function initGallery() {
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      galleryFlippedCards = [];
      
      soulArtCards.forEach((card, index) => {
        const container = createCard(card, false, true);
        container.dataset.index = index;
        gallery.appendChild(container);
      });
    }

    function createCard(card, isLarge = false, isGalleryCard = false) {
      const container = document.createElement('div');
      container.className = 'card-container' + (isLarge ? ' large' : '');
      container.innerHTML = `
        <div class="card-inner">
          <div class="card-front">
            <img src="attached_assets/Temple-card.png" alt="Oracle Card">
          </div>
          <div class="card-back">
            <h2>${card.title}</h2>
            <p>${card.message.replace(/\n/g, '<br>')}</p>
          </div>
        </div>
      `;
      
      container.addEventListener('click', function() {
        this.classList.toggle('flipped');
        
        if (isGalleryCard) {
          updateGalleryFlippedCards();
        }
      });
      
      container.cardData = card;
      return container;
    }

    function updateGalleryFlippedCards() {
      const gallery = document.getElementById('gallery');
      const flippedContainers = gallery.querySelectorAll('.card-container.flipped');
      const galleryButtons = document.getElementById('galleryActionButtons');
      
      galleryFlippedCards = [];
      flippedContainers.forEach(container => {
        if (container.cardData) {
          galleryFlippedCards.push(container.cardData);
        }
      });
      
      if (galleryFlippedCards.length > 0 && isAuthenticated) {
        galleryButtons.style.display = 'flex';
      } else {
        galleryButtons.style.display = 'none';
      }
    }

    async function saveGallerySelection() {
      if (!isAuthenticated) {
        document.getElementById('loginPrompt').style.display = 'block';
        return;
      }
      
      if (galleryFlippedCards.length === 0) {
        return;
      }
      
      const saveBtn = document.getElementById('gallerySaveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        const response = await fetch('/api/oracle/readings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cards_drawn: galleryFlippedCards.map(c => c.title),
            card_messages: galleryFlippedCards.map(c => c.message)
          })
        });
        
        if (response.ok) {
          const successMessage = document.getElementById('gallerySuccessMessage');
          const timestamp = new Date().toLocaleString();
          successMessage.innerHTML = `${galleryFlippedCards.length} card(s) saved at ${timestamp}. View in your <a href="profile.html" style="color: #c9a227;">profile</a>.`;
          successMessage.style.display = 'block';
          
          saveBtn.textContent = 'Saved';
        } else {
          throw new Error('Failed to save');
        }
      } catch (e) {
        saveBtn.textContent = 'Save Selected Cards to Profile';
        saveBtn.disabled = false;
        alert('Could not save reading. Please try again.');
      }
    }

    function drawRandom(count) {
      const drawArea = document.getElementById('drawArea');
      const actionButtons = document.getElementById('actionButtons');
      const journalSection = document.getElementById('journalSection');
      const successMessage = document.getElementById('successMessage');
      
      drawArea.innerHTML = '';
      successMessage.style.display = 'none';
      currentReadingId = null;
      
      let numCards;
      if (count === 'random') {
        numCards = Math.floor(Math.random() * 5) + 1;
      } else {
        numCards = count;
      }
      
      const shuffled = [...soulArtCards].sort(() => Math.random() - 0.5);
      currentDrawnCards = shuffled.slice(0, numCards);
      
      currentDrawnCards.forEach(card => {
        const container = createCard(card, true);
        drawArea.appendChild(container);
      });
      
      actionButtons.style.display = 'flex';
      
      if (isAuthenticated) {
        journalSection.style.display = 'block';
        document.getElementById('reflectionText').value = '';
      }
      
      updateUIForAuth();
      drawArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function resetDraw() {
      const drawArea = document.getElementById('drawArea');
      const actionButtons = document.getElementById('actionButtons');
      const journalSection = document.getElementById('journalSection');
      const successMessage = document.getElementById('successMessage');
      const loginPrompt = document.getElementById('loginPrompt');
      
      drawArea.innerHTML = '';
      actionButtons.style.display = 'none';
      journalSection.style.display = 'none';
      successMessage.style.display = 'none';
      loginPrompt.style.display = 'none';
      currentDrawnCards = [];
      currentReadingId = null;
    }

    async function saveReading() {
      if (!isAuthenticated) {
        document.getElementById('loginPrompt').style.display = 'block';
        return;
      }
      
      if (currentDrawnCards.length === 0) {
        return;
      }
      
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      
      try {
        const response = await fetch('/api/oracle/readings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cards_drawn: currentDrawnCards.map(c => c.title),
            card_messages: currentDrawnCards.map(c => c.message)
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          currentReadingId = data.id;
          
          const successMessage = document.getElementById('successMessage');
          const timestamp = new Date().toLocaleString();
          successMessage.innerHTML = `Reading saved at ${timestamp}. View it in your <a href="profile.html" style="color: #c9a227;">profile</a>.`;
          successMessage.style.display = 'block';
          
          saveBtn.textContent = 'Saved';
        } else {
          throw new Error('Failed to save');
        }
      } catch (e) {
        saveBtn.textContent = 'Save Sacred Reading';
        saveBtn.disabled = false;
        alert('Could not save reading. Please try again.');
      }
    }

    async function saveJournalReflection() {
      if (!currentReadingId) {
        await saveReading();
      }
      
      if (!currentReadingId) {
        return;
      }
      
      const reflection = document.getElementById('reflectionText').value.trim();
      if (!reflection) {
        alert('Please write your reflection before saving.');
        return;
      }
      
      const journalBtn = document.getElementById('journalSaveBtn');
      journalBtn.disabled = true;
      journalBtn.textContent = 'Saving...';
      
      try {
        const response = await fetch(`/api/oracle/readings/${currentReadingId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reflection })
        });
        
        if (response.ok) {
          const successMessage = document.getElementById('successMessage');
          successMessage.innerHTML = `Reading and reflection saved. View it in your <a href="profile.html" style="color: #c9a227;">profile</a>.`;
          successMessage.style.display = 'block';
          
          journalBtn.textContent = 'Reflection Saved';
        } else {
          throw new Error('Failed to save reflection');
        }
      } catch (e) {
        journalBtn.textContent = 'Save Reflection';
        journalBtn.disabled = false;
        alert('Could not save reflection. Please try again.');
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      initGallery();
    });
  </script>
</body>
</html>
